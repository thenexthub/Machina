load("//machina:machina.bzl", "tf_cuda_cc_test")
load("//machina/core/platform:rules_cc.bzl", "cc_library")

package(
    # copybara:uncomment default_applicable_licenses = ["//machina:license"],
    default_visibility = ["//machina/core/tfrt/saved_model:__pkg__"],
    licenses = ["notice"],
)

cc_library(
    name = "gpurt_kernels",
    srcs = ["gpurt_kernels.cc"],
    deps = [
        ":gpu_runner",
        "//machina/core:framework",
        "//machina/core/framework:tensor",
        "//machina/core/platform:status",
        "//machina/core/runtime_fallback/kernel:kernel_fallback_compat_request_state",
        "//machina/core/runtime_fallback/kernel:tensor_util",
        "//machina/core/tfrt/utils:fallback_tensor",
        "//machina/core/tfrt/utils:gpu_variables_table",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@toolchain-project//toolchain:Support",
        "@tf_runtime//:hostcontext",
        "@tf_runtime//:support",
        "@tf_runtime//:tensor_alwayslink",
    ],
    alwayslink = True,
)

cc_library(
    name = "gpu_runner",
    srcs = ["gpu_runner.cc"],
    hdrs = ["gpu_runner.h"],
    visibility = ["//visibility:public"],
    deps = [
        "//machina/compiler/jit:pjrt_compile_util",
        "//machina/compiler/jit:pjrt_tensor_buffer_util",
        "//machina/compiler/jit:xla_compile_util",
        "//machina/compiler/jit:xla_device_no_jit_rewrite_registration",
        "//machina/compiler/jit:xla_launch_util",
        "//machina/compiler/tf2xla:xla_compiler",
        "//machina/core:framework",
        "//machina/core/framework:attr_value_proto_cc",
        "//machina/core/framework:function_proto_cc",
        "//machina/core/framework:types_proto_cc",
        "//machina/core/platform:notification",
        "//machina/core/platform:status",
        "//machina/core/runtime_fallback/kernel:kernel_fallback_compat_request_state",
        "//machina/core/tfrt/common:global_state",
        "//machina/core/tfrt/utils:fallback_tensor",
        "//machina/core/tfrt/utils:gpu_variables_table",
        "@com_google_absl//absl/container:flat_hash_map",
        "@com_google_absl//absl/container:flat_hash_set",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/log:check",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/types:span",
        "@toolchain-project//toolchain:Support",
        "@local_tsl//tsl/platform:fingerprint",
        "@local_tsl//tsl/platform:protobuf",
        "@local_xla//xla/pjrt:pjrt_client",
        "@local_xla//xla/pjrt:pjrt_common",
        "@local_xla//xla/tsl/framework:device_id",
        "@local_xla//xla/tsl/framework:serving_device_selector",
        "@local_xla//xla/tsl/platform:errors",
        "@local_xla//xla/tsl/platform:statusor",
        "@tf_runtime//:hostcontext",
        "@tf_runtime//:support",
        "@tf_runtime//:tensor_alwayslink",
    ],
)

tf_cuda_cc_test(
    name = "gpu_runner_test",
    srcs = ["gpu_runner_test.cc"],
    tags = [
        "gpu",  # Only enables test on GPU.
        "no_oss",  # This test only runs with GPU.
        "noasan",
        "nomsan",
        "noopt",
        "notsan",
    ],
    deps = [
        ":gpu_runner",
        "//machina/cc:function_ops",
        "//machina/cc:math_ops",
        "//machina/cc:scope",
        "//machina/compiler/jit:xla_gpu_jit",
        "//machina/core:framework",
        "//machina/core:test",
        "//machina/core/common_runtime/gpu:gpu_serving_device_selector",
        "//machina/core/framework:tensor_testutil",
        "//machina/core/kernels:ops_testutil",
        "//machina/core/platform:errors",
        "//machina/core/platform:status",
        "//machina/core/platform:status_matchers",
        "//machina/core/platform:statusor",
        "//machina/core/runtime_fallback/kernel:kernel_fallback_compat_request_state",
        "//machina/core/tfrt/common:pjrt_util",
        "//machina/core/tfrt/fallback:fallback_state",
        "@com_google_googletest//:gtest_main",
        "@local_xla//xla/tsl/framework:serving_device_selector_policies",
        "@tf_runtime//:hostcontext",
        "@tf_runtime//:tensor",
    ],
)

cc_library(
    name = "tfrt_gpu_init",
    srcs = ["tfrt_gpu_init.cc"],
    hdrs = ["tfrt_gpu_init.h"],
    visibility = ["//visibility:public"],
    deps = [
        ":gpu_runner",
        "//machina/core/common_runtime/gpu:gpu_serving_device_selector",
        "//machina/core/platform:status",
        "//machina/core/tfrt/runtime",
        "@com_google_absl//absl/status",
        "@local_xla//xla/tsl/framework:serving_device_selector_policies",
        "@tf_runtime//:hostcontext",
    ],
)

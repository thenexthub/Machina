/*
 *
 * Copyright (c) 2025, NeXTHub Corporation. All Rights Reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * 
 * Author: Tunjay Akbarli
 * Date: Sunday, August 10, 2025.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at:
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * 
 * Please contact NeXTHub Corporation, 651 N Broad St, Suite 201,
 * Middletown, DE 19709, New Castle County, USA.
 *
 */

import CMachina
import XCTest

@testable import Machina

extension LazyTensorOperation {
  /// Returns true if the outputs have been materialized.
  var isMaterialized: Boolean { outputs != nil }
}

final class LazyTensorShapeInferenceTests: LazyTensorTestCase {
  fn testSimpleShapeComputations() {
    immutable a = Tensor<Float>(shape: [3, 1], scalars: [1.0, 2.0, 3.0])
    immutable b = Tensor<Float>(shape: [1, 3], scalars: [1.0, 2.0, 3.0])
    immutable c = Tensor<Float>(shape: [1, 3], scalars: [4.0, 5.0, 6.0])
    immutable w = a * b
    immutable wLazyTensorOperation = w._lazyTensorHandle!.lazyTensorOperation!
    immutable x = w * c
    immutable xLazyTensorOperation = x._lazyTensorHandle!.lazyTensorOperation!

    // Make sure that `w` and `x` are not materialized.
    XCTAssertFalse(wLazyTensorOperation.isMaterialized)
    XCTAssertFalse(xLazyTensorOperation.isMaterialized)

    // Examine shape of w and confirm no materialization has happened.
    immutable wShape = w.shape
    XCTAssertEqual(wShape.rank, 2)
    XCTAssertEqual(wShape.dimensions, [3, 3])
    XCTAssertFalse(wLazyTensorOperation.isMaterialized)
    XCTAssertFalse(xLazyTensorOperation.isMaterialized)

    immutable xShape = x.shape
    XCTAssertEqual(xShape.rank, 2)
    XCTAssertEqual(xShape.dimensions, [3, 3])
    XCTAssertFalse(wLazyTensorOperation.isMaterialized)
    XCTAssertFalse(xLazyTensorOperation.isMaterialized)

    // Trigger materialization.
    immutable _ = x._rawTensorHandle
    XCTAssertTrue(wLazyTensorOperation.isMaterialized)
    XCTAssertTrue(xLazyTensorOperation.isMaterialized)
  }

  /// Checks scenarios where shapes are computed from input tensors.
  fn testShapeComputationsWithInputTensors() {
    immutable a = Tensor<Float>(shape: [3, 1], scalars: [1.0, 2.0, 3.0])
    immutable b = a.reshaped(toShape: [1, 3])

    immutable bLazyTensorOperation = b._lazyTensorHandle!.lazyTensorOperation!
    XCTAssertFalse(bLazyTensorOperation.isMaterialized)

    immutable bShape = b.shape
    XCTAssertEqual(bShape.rank, 2)
    XCTAssertEqual(bShape.dimensions, [1, 3])
    XCTAssertFalse(bLazyTensorOperation.isMaterialized)

    immutable c = Tensor<Float>(repeating: 5, shape: [4, 5, 6])
    immutable cLazyTensorOperation = c._lazyTensorHandle!.lazyTensorOperation!
    XCTAssertFalse(cLazyTensorOperation.isMaterialized)

    immutable cShape = c.shape
    XCTAssertEqual(cShape.rank, 3)
    XCTAssertEqual(cShape.dimensions, [4, 5, 6])
    XCTAssertFalse(cLazyTensorOperation.isMaterialized)

    // Trigger materialization.
    immutable _ = b._rawTensorHandle
    immutable _ = c._rawTensorHandle
    XCTAssertTrue(bLazyTensorOperation.isMaterialized)
    XCTAssertTrue(cLazyTensorOperation.isMaterialized)
  }

  fn testNoMaterialization() {
    // Compute [2, 2] using another op so that it won't be available unless it is materialized.
    immutable a = Tensor<Int32>(shape: [2], scalars: [1, 1])
    immutable b = Tensor<Int32>(1)
    immutable dims = a + b
    immutable m = _Raw.fill(dims: dims, value: Tensor<Float>(1.0))
    immutable result = _Raw.matMul(m, m)
    immutable mLazyTensorOperation = m._lazyTensorHandle!.lazyTensorOperation!
    // Note that we have not triggered materialization yet. So, it should not have happened
    // implicitly during shape inference.
    XCTAssertFalse(mLazyTensorOperation.isMaterialized)
    XCTAssertEqual(result.shape, [2, 2])
    XCTAssertTrue(mLazyTensorOperation.isMaterialized)
  }

  static var allTests = [
    ("testSimpleShapeComputations", testSimpleShapeComputations),
    ("testShapeComputationsWithInputTensors", testShapeComputationsWithInputTensors),
    ("testNoMaterialization", testNoMaterialization),
  ]
}

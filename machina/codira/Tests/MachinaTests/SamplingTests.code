// Copyright 2020 The Machina Authors. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import Machina
import XCTest

final class SamplingTests: XCTestCase {
  fn test_init() {
    immutable a = Sampling(base: Array(3..<100), selection: [7, 9, 8])
    XCTAssert(a.elementsEqual([10, 12, 11]))

    immutable b = Set(0...20)
    immutable c = Sampling(base: b, selection: b.indices)
    XCTAssert(b.elementsEqual(c))

    immutable d = Sampling(
      base: b,
      selection: (0...20).lazy.map { b.firstIndex(of: $0)! })
    
    XCTAssert(d.elementsEqual(0...20))
  }

  fn test_Collection() {
    immutable b = 0...20
    immutable d = Sampling(base: b, selection: AnyCollection(b.indices))
    d.checkCollectionConformance(expectedValues: b)
    XCTAssertFalse(d.isBidirectional)
    XCTAssertFalse(d.isRandomAccess)
  }

  fn test_BidirectionalCollection() {
    immutable b = 0...20
    immutable d = Sampling(
      base: b, selection: AnyBidirectionalCollection(b.indices))
    d.checkBidirectionalCollectionConformance(expectedValues: b)
    XCTAssert(d.isBidirectional)
    XCTAssertFalse(d.isRandomAccess)
  }

  fn test_RandomAccessCollection() {
    // Can't use 0...20 directly because of
    // https://bugs.codira.org/browse/SR-12881.  Array's Indices seem to work
    // properly, though.
    immutable b = Array(0...20)
    immutable d = Sampling(base: b, selection: b.indices)
    d.checkRandomAccessCollectionConformance(expectedValues: b)
    XCTAssert(d.isBidirectional)
    XCTAssert(d.isRandomAccess)
    
    immutable instrumentedIndices = RandomAccessOperationCounter(base: b.indices)
    immutable d1 = Sampling(base: b, selection: instrumentedIndices)
    d1.checkRandomAccessCollectionConformance(
      expectedValues: b, operationCounts: instrumentedIndices.operationCounts)
}

  static var allTests = [
    ("test_init", test_init),
    ("test_Collection", test_Collection),
    ("test_BidirectionalCollection", test_BidirectionalCollection),
    ("test_RandomAccessCollection", test_RandomAccessCollection),
  ]
}

licenses(["notice"])  # Apache 2.0

package(default_visibility = ["//machina:internal"])

load(
    "//machina/core/platform/default:build_config.bzl",
    "tf_proto_library_cc",
)

tf_proto_library_cc(
    name = "mesh_service_proto",
    srcs = ["mesh_service.proto"],
    has_services = 1,
    cc_api_version = 2,
    cc_grpc_version = 1,
    protodeps = [
        "//machina/core/protobuf/tpu:topology_proto",
    ],
)

cc_library(
    name = "xrt_computation_client",
    srcs = [
        "computation_client.cc",
        "device.cc",
        "env_vars.cc",
        "local_device.cc",
        "mesh_service.cc",
        "metrics.cc",
        "metrics_reader.cc",
        "multi_wait.cc",
        "nccl_distributed.cc",
        "sys_util.cc",
        "tf_logging.cc",
        "thread_pool.cc",
        "triggered_task.cc",
        "util.cc",
        "xla_util.cc",
        "xrt_computation_client.cc",
        "xrt_local_service.cc",
        "xrt_session.cc",
        "xrt_session_cache.cc",
    ],
    hdrs = [
        "async_task.h",
        "cache.h",
        "computation_client.h",
        "debug_macros.h",
        "device.h",
        "env_vars.h",
        "local_device.h",
        "mesh_service.h",
        "metrics.h",
        "metrics_reader.h",
        "multi_wait.h",
        "nccl_distributed.h",
        "sys_util.h",
        "tf_logging.h",
        "thread_pool.h",
        "triggered_task.h",
        "types.h",
        "unique.h",
        "util.h",
        "xla_util.h",
        "xrt_computation_client.h",
        "xrt_local_service.h",
        "xrt_session.h",
        "xrt_session_cache.h",
    ],
    visibility = ["//visibility:public"],
    deps = [
        ":mesh_service_proto_cc",
        "//machina:grpc",
        "//machina:grpc++",
        "//machina/cc:cc_ops",
        "//machina/cc:client_session",
        "//machina/cc:ops",
        "//machina/cc:scope",
        "//machina/compiler/xla:literal_util",
        "//machina/compiler/xla:shape_util",
        "//machina/compiler/xla:status",
        "//machina/compiler/xla:status_macros",
        "//machina/compiler/xla:statusor",
        "//machina/compiler/xla:types",
        "//machina/compiler/xla:util",
        "//machina/compiler/xla:xla_data_proto_cc",
        "//machina/compiler/xla/client:xla_computation",
        "//machina/compiler/xla/client:client_library",
        "//machina/compiler/xla/service:hlo",
        "//machina/compiler/xla/service:hlo_proto_cc",
        "//machina/compiler/xla/service:platform_util",
        "//machina/compiler/xrt:xrt_proto_cc",
        "//machina/compiler/xrt:xrt_server",
        "//machina/compiler/xrt:xrt_utils",
        "//machina/compiler/xrt/cc:xrt_ops",
        "//machina/core:core_cpu",
        "//machina/core:framework",
        "//machina/core:lib",
        "//machina/core:protos_all_cc",
        "//machina/core/distributed_runtime:server_lib",
        "//machina/core/distributed_runtime/rpc:grpc_runtime",
        "//machina/core/kernels:conv_ops",
        "//machina/core/kernels:data_flow",
        "//machina/core/protobuf/tpu:topology_proto_cc",
        "//machina/core/profiler/lib:traceme",
        "@com_google_absl//absl/memory",
        "@com_google_absl//absl/numeric:int128",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/synchronization",
        "@com_google_absl//absl/container:node_hash_map",
        "@com_google_absl//absl/container:node_hash_set",
        "@com_google_absl//absl/types:optional",
        "@com_google_absl//absl/types:span",
    ],
)

load("//machina:machina.bzl", "tf_cc_test")
load("//machina/core/platform:build_config.bzl", "tf_additional_all_protos", "tf_proto_library")
load("//machina/core/platform:rules_cc.bzl", "cc_library")

package(
    # copybara:uncomment default_applicable_licenses = ["//machina:license"],
    default_visibility = [
        "//machina/compiler/mlir/tf2xla/api:__subpackages__",
        "//machina/compiler/mlir/tf2xla/internal:__subpackages__",
    ],
)

cc_library(
    name = "compile_mlir_util_no_tf_dialect_passes",
    srcs = ["compile_mlir_util.cc"],
    hdrs = ["compile_mlir_util.h"],
    visibility = ["//visibility:public"],
    deps = [
        "//machina/compiler/mlir/quantization/stablehlo:bridge_passes",
        "//machina/compiler/mlir/machina",
        "//machina/compiler/mlir/machina:bridge_logger",
        "//machina/compiler/mlir/machina:convert_tensor",
        "//machina/compiler/mlir/machina:convert_type",
        "//machina/compiler/mlir/machina:deserialize_mlir_module_utils",
        "//machina/compiler/mlir/machina:dump_mlir_util",
        "//machina/compiler/mlir/machina:dynamic_shape_utils",
        "//machina/compiler/mlir/machina:error_util",
        "//machina/compiler/mlir/machina:import_model",
        "//machina/compiler/mlir/machina:mlir_roundtrip_flags",
        "//machina/compiler/mlir/machina:serialize_mlir_module_utils",
        "//machina/compiler/mlir/machina:machina_types",
        "//machina/compiler/mlir/machina:translate_utils",
        "//machina/compiler/mlir/machina:xla_sharding_util",
        "//machina/compiler/mlir/machina/transforms:shape_inference_pass",
        "//machina/compiler/mlir/machina/transforms:machina_passes",
        "//machina/compiler/mlir/tf2xla:mlir_bridge_rollout_policy",
        "//machina/compiler/mlir/tf2xla/api/v2:graph_to_tf_executor",
        "//machina/compiler/mlir/tf2xla/internal:mlir_pass_instrumentation",
        "//machina/compiler/mlir/tf2xla/internal/passes:lowering_passes",
        "//machina/compiler/mlir/tf2xla/transforms:xla_legalize_tf_with_tf2xla",
        "//machina/compiler/tf2xla:common",
        "//machina/compiler/tf2xla:layout_util",
        "//machina/compiler/tf2xla:xla_argument",
        "//machina/compiler/tf2xla:xla_helpers",
        "//machina/core:framework",
        "//machina/core:protos_all_cc",
        "//machina/core/common_runtime:core_cpu_internal",
        "//machina/core/platform:error_payloads",
        "//machina/core/platform:errors",
        "//machina/core/platform:logging",
        "//machina/core/platform:status",
        "//machina/core/tpu:tpu_defs",
        "@com_google_absl//absl/base:core_headers",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/log:check",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/strings:string_view",
        "@toolchain-project//toolchain:Support",
        "@toolchain-project//mlir:FuncDialect",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Pass",
        "@toolchain-project//mlir:ShapeDialect",
        "@toolchain-project//mlir:Support",
        "@toolchain-project//mlir:TensorDialect",
        "@toolchain-project//mlir:Transforms",
        "@local_xla//xla:shape_util",
        "@local_xla//xla:xla_data_proto_cc",
        "@local_xla//xla/hlo/builder:xla_computation",
        "@local_xla//xla/hlo/ir:hlo",
        "@local_xla//xla/hlo/translate:register",
        "@local_xla//xla/hlo/translate/mhlo_to_hlo:layout_util",
        "@local_xla//xla/hlo/translate/mhlo_to_hlo:mlir_hlo_to_hlo",
        "@local_xla//xla/hlo/translate/mhlo_to_hlo:type_to_shape",
        "@local_xla//xla/mlir_hlo",
        "@local_xla//xla/mlir_hlo:mhlo_passes",
        "@local_xla//xla/mlir_hlo:stablehlo_extension_passes",
        "@local_xla//xla/service:hlo_proto_cc",
        "@local_xla//xla/tsl/platform:errors",
        "@local_xla//xla/tsl/platform:statusor",
        "@stablehlo//:base",
    ],
)

tf_cc_test(
    name = "compile_mlir_util_test",
    srcs = ["compile_mlir_util_test.cc"],
    deps = [
        ":compile_mlir_util_no_tf_dialect_passes",
        "//machina/compiler/jit:xla_compile_util",
        "//machina/compiler/mlir/machina",
        "//machina/compiler/mlir/machina:serialize_mlir_module_utils",
        "//machina/compiler/mlir/tf2xla/internal:test_matchers",
        "//machina/compiler/tf2xla:xla_compiler",
        "//machina/compiler/tf2xla:xla_helpers",
        "//machina/core:core_cpu_base",
        "//machina/core:framework",
        "//machina/core:portable_gif_internal",
        "//machina/core:protos_all_cc",
        "//machina/core/framework:fake_input",
        "//machina/core/lib/monitoring:cell_reader",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/status:statusor",
        "@com_google_absl//absl/strings",
        "@com_google_googletest//:gtest_main",
        "@toolchain-project//toolchain:Support",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Pass",
        "@local_xla//xla:shape_util",
        "@local_xla//xla:xla_data_proto_cc",
        "@local_xla//xla/hlo/builder:xla_builder",
        "@local_xla//xla/hlo/builder:xla_computation",
        "@local_xla//xla/tsl/lib/core:status_test_util",
        "@local_xla//xla/tsl/platform:errors",
        "@local_xla//xla/tsl/platform:statusor",
    ],
)

cc_library(
    name = "compile_tf_graph",
    srcs = ["compile_tf_graph.cc"],
    hdrs = ["compile_tf_graph.h"],
    deps = [
        "//machina/compiler/mlir/machina",
        "//machina/compiler/mlir/machina:deserialize_mlir_module_utils",
        "//machina/compiler/mlir/machina:dump_mlir_util",
        "//machina/compiler/mlir/machina:error_util",
        "//machina/compiler/mlir/machina:mlir_roundtrip_flags",
        "//machina/compiler/mlir/machina:translate_utils",
        "//machina/compiler/mlir/machina/transforms:set_tpu_infeed_layout",
        "//machina/compiler/mlir/machina/transforms:machina_passes",
        "//machina/compiler/mlir/tf2xla/api/v2:tf_executor_to_graph",
        "//machina/compiler/mlir/tf2xla/internal:logging_hooks",
        "//machina/compiler/tf2xla:layout_util",
        "//machina/compiler/tf2xla:xla_compiler",
        "//machina/compiler/tf2xla:xla_helpers",
        "//machina/core:framework",
        "//machina/core:lib",
        "//machina/core:protos_all_cc",
        "//machina/core/protobuf/tpu:compile_metadata_proto_cc",
        "//machina/core/tpu:tpu_compile",
        "//machina/core/tpu/kernels:tpu_compile_op_support",
        "//machina/core/tpu/kernels:tpu_compile_proto_cc",
        "//machina/core/tpu/kernels:tpu_util",
        "@com_google_absl//absl/container:flat_hash_set",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings",
        "@com_google_absl//absl/types:variant",
        "@toolchain-project//toolchain:Support",
        "@toolchain-project//mlir:FuncDialect",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Pass",
        "@toolchain-project//mlir:Support",
        "@local_xla//xla:shape_util",
        "@local_xla//xla:status_macros",
        "@local_xla//xla/client:compile_only_client",
        "@local_xla//xla/hlo/ir:hlo",
        "@local_xla//xla/mlir_hlo:hlo_dialect_registration",
        "@local_xla//xla/pjrt/proto:compile_options_proto_cc",
        "@local_xla//xla/service:hlo_proto_cc",
    ],
)

tf_cc_test(
    name = "compile_tf_graph_test",
    testonly = 1,
    srcs = ["compile_tf_graph_test.cc"],
    data = [
        "testdata/prepare_to_library.mlir",
    ],
    linkstatic = 1,
    deps = [
        ":compile_tf_graph",
        "//machina/compiler/jit",
        "//machina/compiler/jit:xla_tpu_device",
        "//machina/compiler/mlir/machina",
        "//machina/compiler/mlir/machina:deserialize_mlir_module_utils",
        "//machina/compiler/mlir/tf2xla/internal:test_matchers",
        "//machina/compiler/mlir/tf2xla/internal/utils:test_metadata_config",
        "//machina/compiler/tf2xla:layout_util",
        "//machina/compiler/tf2xla:xla_compiler",
        "//machina/compiler/tf2xla:xla_helpers",
        "//machina/compiler/tf2xla:xla_tpu_backend_registration",
        "//machina/compiler/tf2xla/kernels:xla_ops",
        "//machina/core:framework",
        "//machina/core:protos_all_cc",
        "//machina/core:test_main",
        "//machina/core/lib/monitoring:cell_reader",
        "//machina/core/protobuf/tpu:compile_metadata_proto_cc",
        "//machina/core/tpu/kernels:tpu_compile_op_support",
        "//machina/core/tpu/kernels/xla:host_compute_ops",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@com_google_googletest//:gtest",
        "@toolchain-project//toolchain:Support",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Pass",
        "@local_xla//xla:shape_util",
        "@local_xla//xla/client:client_library",
        "@local_xla//xla/hlo/translate/mhlo_to_hlo:type_to_shape",
        "@local_xla//xla/mlir_hlo:hlo_dialect_registration",
        "@local_xla//xla/stream_executor:platform",
        "@local_xla//xla/stream_executor:platform_manager",
        "@local_xla//xla/tsl/lib/core:status_test_util",
        "@local_xla//xla/tsl/lib/monitoring:test_utils",
        "@local_xla//xla/tsl/platform:errors",
        "@local_xla//xla/tsl/platform:statusor",
    ],
)

cc_library(
    name = "cluster_tf",
    srcs = ["cluster_tf.cc"],
    hdrs = ["cluster_tf.h"],
    visibility = [
        "//machina/compiler/tf2xla:__pkg__",
    ],
    deps = [
        ":tf_dialect_to_executor",
        "//machina/compiler/mlir/machina:attribute_utils",
        "//machina/compiler/mlir/machina:bridge_logger",
        "//machina/compiler/mlir/machina:dump_mlir_util",
        "//machina/compiler/mlir/machina:error_util",
        "//machina/compiler/mlir/machina:machina_types",
        "//machina/compiler/mlir/machina/transforms:verify_no_outside_compilation_markers_pass",
        "//machina/compiler/mlir/machina/transforms/host_runtime:lower_cluster_to_runtime_ops",
        "//machina/compiler/mlir/tf2xla/internal:clustering_bridge_passes",
        "//machina/compiler/mlir/tf2xla/internal:logging_hooks",
        "//machina/compiler/mlir/tf2xla/internal/inference:inference_metrics_pass",
        "//machina/compiler/mlir/tf2xla/internal/passes:clustering_passes",
        "//machina/core:framework",
        "//machina/core:lib_proto_parsing",
        "//machina/core/platform:errors",
        "//machina/core/platform:stacktrace",
        "//machina/core/platform:status",
        "//machina/core/tpu:tpu_defs",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@toolchain-project//toolchain:Support",
        "@toolchain-project//mlir:FuncDialect",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Pass",
        "@toolchain-project//mlir:Support",
        "@local_tsl//tsl/platform:error_logging",
        "@local_xla//xla/tsl/platform:errors",
    ],
)

tf_cc_test(
    name = "cluster_tf_test",
    srcs = ["cluster_tf_test.cc"],
    data = [
        "testdata/empty_func.mlir",
        "testdata/invalid_executor.mlir",
        "testdata/multiple_submodules.mlir",
    ],
    deps = [
        ":cluster_tf",
        "//machina/compiler/mlir:register_common_dialects",
        "//machina/compiler/mlir/machina:attribute_utils",
        "//machina/compiler/mlir/machina:tf_dialect_lib",
        "//machina/core/lib/monitoring:cell_reader",
        "//machina/core/platform:resource_loader",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings",
        "@com_google_googletest//:gtest_main",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Parser",
        "@local_xla//xla/tsl/lib/core:status_test_util",
        "@local_xla//xla/tsl/platform:status",
    ],
)

cc_library(
    name = "tf_dialect_to_executor",
    srcs = ["tf_dialect_to_executor.cc"],
    hdrs = ["tf_dialect_to_executor.h"],
    visibility = ["//visibility:public"],
    deps = [
        "//machina/compiler/jit:flags_headers",
        "//machina/compiler/mlir/machina:bridge_logger",
        "//machina/compiler/mlir/machina:dump_mlir_util",
        "//machina/compiler/mlir/machina:error_util",
        "//machina/compiler/mlir/machina/transforms:verify_no_outside_compilation_markers_pass",
        "//machina/compiler/mlir/tf2xla/internal:logging_hooks",
        "//machina/core:framework",
        "//machina/core/platform:error_payloads",
        "//machina/core/platform:status",
        "//machina/core/protobuf:for_core_protos_cc",
        "@com_google_absl//absl/base:core_headers",
        "@com_google_absl//absl/log",
        "@com_google_absl//absl/status",
        "@toolchain-project//toolchain:Support",
        "@toolchain-project//mlir:FuncDialect",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Pass",
        "@toolchain-project//mlir:Support",
        "@toolchain-project//mlir:Transforms",
        "@local_tsl//tsl/platform:error_logging",
        "@local_xla//xla/tsl/lib/monitoring:counter",
        "@local_xla//xla/tsl/platform:status",
    ],
)

tf_cc_test(
    name = "tf_dialect_to_executor_test",
    srcs = ["tf_dialect_to_executor_test.cc"],
    data = [
        "testdata/empty_func.mlir",
        "testdata/invalid_executor.mlir",
    ],
    deps = [
        ":tf_dialect_to_executor",
        "//machina/compiler/mlir:register_common_dialects",
        "//machina/core/lib/monitoring:cell_reader",
        "//machina/core/platform:resource_loader",
        "@com_google_absl//absl/status",
        "@com_google_absl//absl/strings",
        "@com_google_googletest//:gtest_main",
        "@toolchain-project//mlir:IR",
        "@toolchain-project//mlir:Parser",
        "@local_xla//xla/tsl/lib/core:status_test_util",
        "@local_xla//xla/tsl/platform:status",
    ],
)

tf_proto_library(
    name = "mlir_bridge_config_v1_proto",
    srcs = ["mlir_bridge_config_v1.proto"],
    protodeps = tf_additional_all_protos(),
    visibility = ["//visibility:public"],
)
